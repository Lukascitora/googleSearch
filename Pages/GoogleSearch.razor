@page "/"
@using System.Net.Http
@using System.Net.Http.Json
@inject HttpClient Http
@inject IJSRuntime JS

<h1>Vyhledávač Výsledků z Google</h1>

<input @bind="searchQuery" placeholder="Zadejte klíčové slovo" />
<button @onclick="FetchResults">Vyhledat</button>

@if (results != null && results.Count > 0)
{
    <button @onclick="SaveResults">Uložit výsledky</button>
    <ul>
        @foreach (var item in results)
        {
            <li>
                <a href="@item.Link" target="_blank">@item.Title</a>
                <p>@item.Snippet</p>
            </li>
        }
    </ul>
}
else if (isLoading)
{
    <p>Načítání výsledků...</p>
}

@code {
    private string searchQuery;
    private List<ResultItem> results = new List<ResultItem>();
    private bool isLoading = false;

    private async Task FetchResults()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
            return;

        isLoading = true;
        var apiKey = "AIzaSyAK5ufCzcnFQ4V3fo3LMUPOP1cY42SdTMY";
        var cx = "43a79040cac164075";
        var url = $"https://www.googleapis.com/customsearch/v1?key={apiKey}&cx={cx}&q={Uri.EscapeDataString(searchQuery)}";

        try
        {
            var response = await Http.GetFromJsonAsync<GoogleSearchResponse>(url);
            results = response.Items ?? new List<ResultItem>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Chyba při získávání výsledků: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveResults()
    {
        var json = System.Text.Json.JsonSerializer.Serialize(results, new System.Text.Json.JsonSerializerOptions
            {
                WriteIndented = true
            });
        var byteArray = System.Text.Encoding.UTF8.GetBytes(json);
        using var streamRef = new DotNetStreamReference(new MemoryStream(byteArray));
        await JS.InvokeVoidAsync("downloadFileFromStream", "results.json", streamRef);
    }

    public class ResultItem
    {
        public string Title { get; set; }
        public string Link { get; set; }
        public string Snippet { get; set; }
    }

    public class GoogleSearchResponse
    {
        public List<ResultItem> Items { get; set; }
    }
}
